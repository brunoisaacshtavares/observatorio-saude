version: 2.1
orbs:
  windows: circleci/windows@5.0.0

jobs:
  build-and-test:
    executor:
      name: windows/default
    steps:
      - checkout

      - restore_cache:
          keys:
            - nuget-packages-{{ checksum "observatorio.saude.sln" }}
            - nuget-packages-

      - run:
          name: Restore NuGet Packages
          command: dotnet restore observatorio.saude.sln

      - save_cache:
          paths:
            - ~/.nuget/packages
          key: nuget-packages-{{ checksum "observatorio.saude.sln" }}

      - run:
          name: Build Solution
          command: dotnet build observatorio.saude.sln --configuration Release --no-restore

      - run:
          name: Install ReportGenerator Tool
          command: dotnet tool install --global dotnet-reportgenerator-globaltool --version "5.2.0"

      - run:
          name: Run Tests and Collect Coverage
          command: |
            mkdir TestResults\junit
            dotnet test --configuration Release --results-directory TestResults --logger "junit;LogFilePath=TestResults\junit\results.xml;MethodFormat=Class" --collect:"XPlat Code Coverage"

      - run:
          name: Generate HTML Coverage Report
          command: |
            reportgenerator "-reports:TestResults\**\coverage.cobertura.xml" "-targetdir:CoverageReport" "-reporttypes:Html"
          when: always
      - run:
          name: Check for generated files
          command: ls -R TestResults
          when: always

      - store_test_results:
          path: TestResults\junit

      - store_artifacts:
          path: CoverageReport
          destination: coverage-report
          
      - store_artifacts:
          path: TestResults
          destination: raw-test-results

workflows:
  version: 2
  ci:
    jobs:
      - build-and-test
