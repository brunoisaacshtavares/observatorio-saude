# Use a versão 2.1 do motor de pipeline do CircleCI.
version: 2.1

# Orbs são pacotes de configuração reutilizáveis. O orb do .NET simplifica
# tarefas comuns como restaurar pacotes, compilar e testar.
# Veja: https://circleci.com/developer/orbs/orb/circleci/dotnet
orbs:
  dotnet: circleci/dotnet@2.2.0

# Define os jobs a serem executados.
jobs:
  build-and-test:
    # Especifica o ambiente de execução. Usaremos uma imagem Docker mantida
    # pela CircleCI que já vem com o SDK do .NET 8 instalado.
    # Veja: https://circleci.com/developer/images/image/cimg/dotnet
    docker:
      - image: cimg/dotnet:8.0

    # Define os passos a serem executados dentro do job.
    steps:
      # 1. Baixa o código do seu repositório.
      - checkout

      # 2. Restaura as dependências do NuGet.
      # Este comando do orb gerencia o cache automaticamente para acelerar builds futuros.
      - dotnet/restore:
          name: "Restaurando pacotes NuGet"

      # 3. Compila a solução em modo Release.
      - run:
          name: "Compilando a solução"
          # O argumento --no-restore evita baixar os pacotes novamente.
          command: dotnet build --configuration Release --no-restore

      # 4. Executa os testes da sua solução.
      # Este comando do orb também gerencia o cache e pode salvar os resultados dos testes.
      - dotnet/test:
          name: "Executando os testes"
          configuration: "Release"
          no_build: true # Evita que o projeto seja compilado novamente.

# Orquestra os jobs em um workflow.
workflows:
  build-test-dotnet:
    jobs:
      - build-and-test
