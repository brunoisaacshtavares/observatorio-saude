version: 2.1
orbs:
  windows: circleci/windows@5.0.0
jobs:
  build-and-test:
    executor:
      name: windows/default
    steps:
      - checkout

      - restore_cache:
          keys:
            - nuget-packages-{{ checksum "observatorio.saude.sln" }}
            - nuget-packages-

      - run:
          name: Restore (solution)
          command: dotnet restore observatorio.saude.sln

      - save_cache:
          paths:
            - ~/.nuget/packages
          key: nuget-packages-{{ checksum "observatorio.saude.sln" }}

      - run:
          name: Build
          command: dotnet build observatorio.saude.sln --configuration Release --no-restore

      - run:
          name: Install ReportGenerator Tool
          command: dotnet tool install --global dotnet-reportgenerator-globaltool

      - run:
          name: Run tests and collect coverage
          command: |
            dotnet test --no-build --configuration Release --results-directory TestResults --logger "junit;LogFilePath=TestResults/result/results.xml;MethodFormat=Class" --collect:"XPlat Code Coverage;Format=cobertura"

      - run:
          name: Generate HTML coverage report
          command: |
            reportgenerator -reports:"TestResults/**/*.cobertura.xml" -targetdir:"CoverageReport" -reporttypes:Html
          when: always

      - store_test_results:
          path: TestResults/result

      - store_artifacts:
          path: CoverageReport
          destination: coverage-report
          
      - store_artifacts:
          path: TestResults
          destination: test-results

workflows:
  version: 2
  ci:
    jobs:
      - build-and-test
